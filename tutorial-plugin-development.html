<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Plugin Development - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Tutorials</li><li class="nav-item"><a href="tutorial-plugin-development.html">Plugin Development</a></li><li class="nav-item"><a href="tutorial-setup-your-instance.html">Running your own Ti2</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Plugin.html">Plugin</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Plugin.html#validateToken">validateToken</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Plugin.html#getProfile">getProfile</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Plugin.html#updateProfile">updateProfile</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Plugin.html#createLocation">createLocation</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Plugin.html#updateLocation">updateLocation</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Plugin.html#getProducts">getProducts</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Plugin.html#createProduct">createProduct</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Plugin.html#updateProduct">updateProduct</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Plugin.html#searchBooking">searchBooking</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Plugin.html#searchProducts">searchProducts</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Plugin.html#searchAvailability">searchAvailability</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Plugin.html#searchQuote">searchQuote</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Plugin.html#createBooking">createBooking</a></span></li><li class="nav-heading"><a href="global.html">Globals</a></li>
</nav>

<div id="main">
    
    <h1 class="page-title">Plugin Development</h1>
    

    <section>

<header>
    
</header>

<article>
    <h2>Getting Started</h2>
<p>Plugins can extend the functionality of Ti2 and/or provide access to other platforms; you should use one of the following methods to provide a stadandarized way to access other systems; if you want to implement new functionality that is not encompassed on the available methods you are more than welcome to add new methods and contribute to the Ti2 codebase.</p>
<h2>Available Methods</h2>
<p>In oorder for an integration or system apps, we must use a set of standirzed methods to matain a compatibility; there are following methods are available, more can be supported but should be a part of the API TI2 spec to maximize it's compatibility.</p>
<p><strong>General Methods</strong> (should always be included):</p>
<ul>
<li><a href="Plugin.html#validateToken"><code>validateToken</code></a></li>
</ul>
<p><strong>Content Methods</strong> (related to marketing information update for profile, locations and/or products):</p>
<ul>
<li><a href="Plugin.html#getProfile"><code>getProfile</code></a></li>
<li><a href="Plugin.html#updateProfile"><code>updateProfile</code></a></li>
<li><a href="Plugin.html#createLocation"><code>createLocation</code></a></li>
<li><a href="Plugin.html#updateLocation"><code>updateLocation</code></a></li>
<li><a href="Plugin.html#getProducts"><code>getProducts</code></a></li>
<li><a href="Plugin.html#createProduct"><code>createProduct</code></a></li>
<li><a href="Plugin.html#updateProduct"><code>updateProduct</code></a></li>
</ul>
<p><strong>Booking Methods</strong> (all related to bookings and operations):</p>
<ul>
<li><a href="Plugin.html#searchBooking"><code>searchBooking</code></a></li>
<li><a href="Plugin.html#searchProducts"><code>searchProducts</code></a></li>
<li><a href="Plugin.html#searchAvailability"><code>searchAvailability</code></a></li>
<li><a href="Plugin.html#searchQuote"><code>searchQuote</code></a></li>
<li><a href="Plugin.html#createBooking"><code>createBooking</code></a></li>
</ul>
<hr>
<h2>Environment variables</h2>
<p>Plugin environment keys are passed down to the instance while is being created, this is the preferred way of accesing environmen keys from the plugins, such values are not design to hold client / user's API keys or specific data, they are to be stored on the database itself via the AppKey collection.</p>
<p>Plugin ENV variable name convention: ti2_pluginName_environmenVariableName, for example:</p>
<pre class="prettyprint source lang-env"><code>ti2_tourconnect_apiUrl=http://backend:8080
</code></pre>
<h2>Codebase setup</h2>
<p>You can review some of the plugins previously developed and use them as a guide, plugin methods are encourage to include tests and return results on the same format, however the return values can include additional information, currently Ti2 is expected to run on node version 12.22.8; we suggest you use the same for your codebase.</p>
<p>After initializing your git environment for development; you can initialize your node project; we recommend naming your repo ti2-&lt;pluginname&gt; but it is not required.</p>
<pre class="prettyprint source lang-bash"><code>$ node init .
</code></pre>
<h2>Entry file / constructor</h2>
<p>The plugin is expected to have an index.js file that exports a Plugin Class like so:</p>
<pre class="prettyprint source lang-javascript"><code>// index.js
class Plugin {
  constructor(params = {}) { // we get the env variables from here
    Object.entries(params).forEach(([attr, value]) => {
      this[attr] = value;
    });
  }
}
module.exports = Plugin;
</code></pre>
<p>The constructor of the plugins should extend the attributes with the received params, this allows the plugin to receive configurations or settings that are to be used by any user; that is settings that are shared across accounts.</p>
<p>By default Ti2 will pass down all environment variables that match the plugin name to it's constructor; for example, if the following environment variables are defined:</p>
<pre class="prettyprint source"><code>ti2_ventrata_acceptLanguage=en
ti2_travelgate_clientCode=tourconnect
ti2_tourconnect_apiUrl=http://backend:8080
</code></pre>
<p>The plugin named ti2-ventrata would receive acceptLanguage variable and it's value, ti2-travelgate the clientCode variable and ti-touconnect the apiUrl value.</p>
<h2>Method calling</h2>
<p>On the previous example code we are declaring a validateToken method; we are normally expected to receive two parameters one is token and the second one payload.</p>
<pre class="prettyprint source lang-javascript"><code>// index.js
class Plugin {
  constructor(params = {}) { // we get the env variables from here
    Object.entries(params).forEach(([attr, value]) => {
      this[attr] = value;
    });
  }
  async validateToken({
    token: {
      apiKey = this.apiKey,
      apiUrl = this.apiUrl,
    },
  }) {
   // TODO: actually test the apiKey against the integration.
    return assert(apiKey);
  }
}
module.exports = Plugin;
</code></pre>
<p>The token parameter includes all the settings for the current configured user; on these example we are defauring this settings to the ones configured to the pluging when it was instanced; so if the user settings do not include an apiUrl it will fall back to the environment variable on the running server.</p>
<h2>Testing Suite</h2>
<p>The plugin should contain a test file, for the following example assumes we will be using jest as the testing platform.</p>
<pre class="prettyprint source lang-bash"><code>$ npm i -D jest
</code></pre>
<pre class="prettyprint source lang-javascript"><code>// index.test.js
const Plugin = require('./index');

const app = new Plugin({
  jwtKey: process.env.ti2_ventrata_jwtKey,
});

describe('Base Tests', () => {
  const token = { // a valid token to run tests
    apiKey: process.env.ti2_ventrata_apiKey,
    endpoint: process.env.ti2_ventrata_endpoint,
  };
  it('should not validate an invalid api key', async () => {
    const isValid = await app.validateToken({
    token: { apiKey: 'some Randomg Text' }
    }); 
    expect(isValid).toBeFalsy();
  });
  it('should not validate an invalid api key', async () => {
    const isValid = await app.validateToken({
      token,
    }); 
    expect(isValid).toBeTruthy();
  });
});

</code></pre>
<pre class="prettyprint source lang-bash"><code>$ npx jest
</code></pre>
<h2>Deploying</h2>
<h3>To your own Instance</h3>
<p>After setting up a <a href="tutorial-setup-your-instance.html">Ti2 instance</a> you can add your development folder as a package on your instance's npm repo (not on the plugin's instance), like so:</p>
<pre class="prettyprint source lang-json"><code>  &quot;dependencies&quot;: {
    &quot;ti2-myplugin&quot;: &quot;file:../ti2-myplugin&quot;
    }
</code></pre>
<h3>To our hosted instance</h3>
<p><a href="https://www.ti2.travel/contact-us">Contact us</a> with the npm published package to begin the testing and deployment process.</p>
<h2>Extending the base API</h2>
<p>Ti2 uses the <a href="https://swagger.io/specification/">Swagger API specification</a> standard to define it's own methods, you can review the base methods <a href="https://ti2-staging.tourconnect.com/api-docs/">here</a>; these methods can be extender using the same format; this allows any plugin to extend the base API endpoints that are linked to any plugin method (part of the base methods or new ones).</p>
<p>All the extender methods would be availble under the /[plugin name] namespace, i.e.: /ti2-greatPlugin/ping.</p>
<p>For Ti2 to pickup the extender definition one must create a new file on the root of the plugin named api.yml, such file would contain only the methods to be extender and it must comply with the current swagger version used on ti2.</p>
<pre class="prettyprint source lang-yaml"><code># api.yml
openapi: '3.0.0'
info:
  description: My amazing ti2-plugin
  version: 0.0.1 
  title: Ti2's new plugin
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    ServerInfo:
      type: object
      properties:
        name:
          type: string
        description:
          type: string
        version:
          type: string
        uptime:
          type: string
paths:
  /ping:
    get:
      tags:
        - public
      summary: Should return basic system status
      operationId: ping
      responses:
        '200':
          description: success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServerInfo'
</code></pre>
<h2>Database Migrations (plugin's own database tables)</h2>
<p>Ti2 uses <a href="https://sequelize.org/v6">Sequelize v6.13</a> and is the database ORM we ecourage to use, you can add your own tables via migrations that should be placed under a migrations folder on the root of the plugin folder.</p>
<p>Migrations should be run after the fact, from the root of ti2 instance like so:</p>
<pre class="prettyprint source"><code>$  npm explore ti2&lt;pluginName> -- npx sequelize db:migrate&quot;
</code></pre>
<p>We strongly encourage all the plugin's table names are predicated with the plugin name (i.e. ti2-pluginName-cacheTable).</p>
<p>This should be executed ater the ti2 project migrations have been executed.</p>
<h2>Scheduled Task (to be released on v2)</h2>
<p>TBD.</p>
</article>

</section>

</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.10</a> using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>